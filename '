const PLAYER = OBJ_EVENT_ID_PLAYER
const HIKO = 1

script OkayLetsFixit_HideObject_Script {
    setflag(FLAG_TEMP_1)
}

script OkayLetsFixit_ReachTop_Script {

    checkitem(ITEM_METEORITE,1)
        if (!var(VAR_RESULT)) {
            release
                end
        }

        lock

        addvar(VAR_STORYLINE_STATE,1)

        applymovement(PLAYER,OkayLetsFixit_WalkToPeak)
        waitmovement(0)
        msgbox(gText_OkayLetsFixIt_TheBambooStar)
        closemessage

        playse(SE_M_DETECT)
        dofieldeffectsparkle(17,42,0)
        waitfieldeffect(FLDEFF_SPARKLE)
        playse(SE_ORB)
        fadescreen(FADE_TO_WHITE)
        delay(150)
        clearflag(FLAG_TEMP_1)
        addobject(HIKO)
        fadescreen(FADE_FROM_WHITE)

        msgbox(gText_OkayLetsFixIt_ImGladYouCame)

        applymovement(PLAYER,OkayLetsFixit_LookAround)
        waitmovement(0)

        setvar(VAR_0x8000, MUGSHOT_HILDA)
        callnative(DrawMugshot)
        msgbox(gText_OkayLetsFixIt_WhatWhereDidYou)
        callnative(ClearMugshot)

        msgbox(gText_OkayLetsFixIt_HaveYouRealized)

        setvar(VAR_0x8000, MUGSHOT_HILDA)
        callnative(DrawMugshot)
        msgbox(gText_OkayLetsFixIt_InComingHere)
        callnative(ClearMugshot)

        msgbox(gText_OkayLetsFixIt_LetsLookBack)
        
        setflag(FLAG_DONT_TRANSITION_MUSIC) 
        warpsilent(MAP_OKAY_LETS_FIXIT_FLASHBACK,255,9,4)
}

script OkayLetsFixit_StartFlashback {
        lock
        call(Script_SetGrayscaleTint)

        setvar(VAR_0x8000, MUGSHOT_HILDA)
        callnative(DrawMugshot)
        msgbox(gText_OkayLetsFixIt_ThisWasTheNight)
        callnative(ClearMugshot)

        msgbox(gText_OkayLetsFixIt_Why)

        setvar(VAR_0x8000, MUGSHOT_HILDA)
        callnative(DrawMugshot)
        msgbox(gText_OkayLetsFixIt_IWasTryingToHelp)
        callnative(ClearMugshot)

        msgbox(gText_OkayLetsFixIt_WouldYouChoose)

        setvar(VAR_0x8000, MUGSHOT_HILDA)
        callnative(DrawMugshot)
        msgbox(gText_OkayLetsFixIt_IfICouldDoItOver)
        closemessage
        callnative(ClearMugshot)
        warpsilent(MAP_PSFPLACE1,255,17,43) 
        call(Script_RemoveTint)
}

script OkayLetsFixit_ReturnToPeak_Script {
        lock
            
        applymovement(PLAYER,Common_Movement_FaceLeft)
        waitmovement(0)

        applymovement(PLAYER,OkayLetsFixit_WatchCliffWalk)
        applymovement(HIKO,OkayLetsFixit_WalkOffCliff)
        waitmovement(0)

        setvar(VAR_0x8000, MUGSHOT_HILDA)
        callnative(DrawMugshot)
        msgbox(gText_OkayLetsFixIt_WaitWhatWhoAreYou)
        callnative(ClearMugshot)

        msgbox(gText_OkayLetsFixIt_IHopeYouMake)
        //PSF TODO Implement glowing with Hiko as source, mimic "DoOrbEffect"

        //Hiko's sprite begins to glow. The screen fades to white, and then fades back in, replaced with the silhouette of Jirachi. Jirachi's cry plays and the screen fades to black.

        //INT. PSFCITY3 COMPOUND

        //The player is lying in bed. They stand up and walk out of the bed.

        setvar(VAR_0x8000, MUGSHOT_HILDA)
        callnative(DrawMugshot)
        msgbox(gText_OkayLetsFixIt_WhatTheHell)
        callnative(ClearMugshot)

        //The player paces back and forth.

        setvar(VAR_0x8000, MUGSHOT_HILDA)
        callnative(DrawMugshot)
        msgbox(gText_OkayLetsFixIt_IHaveNoIdea)
        callnative(ClearMugshot)

        //The player regains control.
}
text gText_OkayLetsFixIt_TheBambooStar {
    format("The Bamboo Star is glowing!")
}

text gText_OkayLetsFixIt_ImGladYouCame {
    format("Ah {PLAYER}, I'm glad you came. I'm Hiko.")
}

text gText_OkayLetsFixIt_WhatWhereDidYou {
    format("What… where… did you come from?! What the hell is going on?")
}

text gText_OkayLetsFixIt_HaveYouRealized {
    format("Have you realized the error in your ways?")
}

text gText_OkayLetsFixIt_InComingHere {
    format("In coming here? Yeah, I think - ")
}

text gText_OkayLetsFixIt_LetsLookBack {
    format("Let's look back.")
}

text gText_OkayLetsFixIt_ThisWasTheNight {
    format("This was the night I decided to help Psfbadguy.")
}

text gText_OkayLetsFixIt_Why {
    format("Why?")
}

text gText_OkayLetsFixIt_IWasTryingToHelp {
    format("I was trying to help. I thought that was the right thing! But… I'm not sure now")
}

text gText_OkayLetsFixIt_WouldYouChoose {
    format("Would you choose differently?")
}

text gText_OkayLetsFixIt_IfICouldDoItOver {
    format("If I could do it over? I think so. I think I made the problem worse.")
}

text gText_OkayLetsFixIt_WaitWhatWhoAreYou {
    format("Wait what - who are you? How are you -")
}

text gText_OkayLetsFixIt_IHopeYouMake {
    format("I hope you make the right decision this time, {PLAYER}.")
}

text gText_OkayLetsFixIt_WhatTheHell {
    format("What the hell was that? That dream was… insane. What the hell did I eat for dinner?")
}

text gText_OkayLetsFixIt_IHaveNoIdea {
    format("…I have no idea what I'm going to do. Do I help Psfbadguy and the police end Psfgoodteam permanently? Or do I help Psfgoodteam clear their name and help the people of Psfregion1?")
}

movement OkayLetsFixit_WalkToPeak {
    walk_up * 4
        walk_left * 7
        step_end
}
