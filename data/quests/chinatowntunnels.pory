const ELDEST = 8
const PLAYER = OBJ_EVENT_ID_PLAYER

script Quest_ChinatownTunnels_Event_Script{

questmenu(QUEST_MENU_CHECK_ACTIVE,QUEST_CHINATOWNTUNNELS)
    if (var(VAR_RESULT)){
        goto(Quest_ChinatownTunnels_Active_Event_Script)
    }

questmenu(QUEST_MENU_CHECK_COMPLETE,QUEST_CHINATOWNTUNNELS)
    if (var(VAR_RESULT)){
        return
    }
}

script Quest_ChinatownTunnels_Active_Event_Script{
    switch(var(VAR_QUEST_CHINATOWN_TUNNELS)){
        case 0:goto(Quest_ChinatownTunnels_Intro_Dialogue)
        case 1:goto(Quest_ChinatownTunnels_BadgeCheck_Dialogue)
}
}

script Quest_ChinatownTunnels_Intro_Dialogue{
    lock
    msgbox(gText_Quest_ChinatownTunnels_OhoHowCanIHelp,MSGBOX_NPC)

    setvar(VAR_MUGSHOT,MUGSHOT_HILDA)
    callnative(DrawMugshot)
    msgbox(gText_Quest_ChinatownTunnels_IHeardOnlineThatYou,MSGBOX_NPC)
    callnative(ClearMugshot)
    addvar(VAR_QUEST_CHINATOWN_TUNNELS,1)
    goto(Quest_ChinatownTunnels_BadgeCheck_Dialogue)
}

script Quest_ChinatownTunnels_BadgeCheck_Dialogue{
    lock
    special(GetNumberOfBadges)
	if (var(VAR_TEMP_0) > 3) {
        goto(Quest_ChinatownTunnels_RevealSecret_Dialogue)
    }
    else {
        msgbox(gText_Quest_ChinatownTunnels_YoureNotStrongEnough,MSGBOX_NPC)
    }
    release
    end
}

script Quest_ChinatownTunnels_RevealSecret_Dialogue{
    addvar(VAR_QUEST_CHINATOWN_TUNNELS,1)
    msgbox(gText_Quest_ChinatownTunnels_HmmYouLookStrong,MSGBOX_NPC)
    closemessage

    applymovement(ELDEST,Common_Movement_FaceAwayPlayer)
    waitmovement(ELDEST)
    delay(16)

    applymovement(ELDEST,Common_Movement_FacePlayer)
    waitmovement(ELDEST)
    msgbox(gText_Quest_ChinatownTunnels_YouveHeardCorrectly,MSGBOX_NPC)
    closemessage
    release
    end
}

script Quest_ChinatownTunnels_FirstScrollWarp_Script{
    lock
    call(Chinatown_Racisthouse_ScrollNoWarp_Dialogue)
    
    setvar(VAR_MUGSHOT,MUGSHOT_HILDA)
    callnative(DrawMugshot)
    msgbox(gText_Quest_ChinatownTunnels_WaitIsThis,MSGBOX_DEFAULT)
    callnative(ClearMugshot)

    applymovement(PLAYER,Quest_ChinatownTunnels_PushScroll_Movement)
    delay(4)
    playse(SE_PIN)
    waitmovement(PLAYER)

    msgbox(gText_Quest_ChinatownTunnels_TheresNoWall,MSGBOX_DEFAULT)
    addvar(VAR_QUEST_CHINATOWN_TUNNELS,1)
    goto(Chinatown_Racisthouse_ScrollWarp_Script)
}

script Chinatown_Racisthouse_ScrollWarp_Script{
    lock
    warpsilent(MAP_CHINATOWN_TUNNEL,1)
    release
    end
}

movement Quest_ChinatownTunnels_PushScroll_Movement{
    walk_in_place_up
    emote_exclamation_mark
    step_end
}

text gText_Quest_ChinatownTunnels_OhoHowCanIHelp{
	format("Oho, how can I help you, lad?")
}
text gText_Quest_ChinatownTunnels_IHeardOnlineThatYou{
	format("I heard there's a secret treasure hidden in this town. Do you know anything about that?")
}
text gText_Quest_ChinatownTunnels_YoureNotStrongEnough{
	format("You're not strong enough for this treasure. Come back after you've got 4 badges.")
}
text gText_Quest_ChinatownTunnels_HmmYouLookStrong{
	format("Hmm, you look strong enough for the task.")
}
text gText_Quest_ChinatownTunnels_YouveHeardCorrectly{
	format("You've heard correctly. There are secret tunnels under the city, and hidden in them is a treasure greater than anybody knows. Of course, I'm too old to go get it now. Find it, and I'll split it with you. The entrance is guarded by a red scroll, but I don't remember where that is...")
}
text gText_Quest_ChinatownTunnels_WaitIsThis{
    format("Wait, is this the red scroll that guy was talking about...?")
}

text gText_Quest_ChinatownTunnels_TheresNoWall{
    format("There's no wall behind the scroll!")
}
